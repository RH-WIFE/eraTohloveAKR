;EVENT_S.ERB、EVENT_SUB、追加処理及びサブイベント
;-------------------------------------------------
;日付が変わった時のイベント
;-------------------------------------------------
@EVENT_NEXTDAY
$INPUT_LOOP_2

;具現持ちでレズ経験orゲイ経験2500以上
IF TARGET >= 0 
	IF !TALENT:半陰半陽 && !TALENT:ふたなり && !TALENT:カントボーイ && !TALENT:シーメール && TALENT:具現 && (EXP:レズ経験 >= 2500 || EXP:ゲイ経験 >= 2500)
		DRAWLINE
		PRINTFORML ……どうやら[具現]の効果が現れそうだ
		PRINTFORM %CALLNAME%を[
		IF TALENT:オトコ
			PRINT 半陰半陽
		ELSE
			PRINT ふたなり
		ENDIF
		PRINTL ]にしますか？
		PRINTL [0] - する
		PRINTL [1] - しない
		INPUT
		IF RESULT == 0
			C = TARGET
			;CALL FUTANARI
		ELSEIF RESULT == 1
			PRINTFORML %CALLNAME%は[具現]を失った
			TALENT:具現 = 0
		ELSE
			GOTO INPUT_LOOP_2
		ENDIF
		DRAWLINE
		WAIT
	ENDIF
ENDIF

;絶頂放尿経験30以上でおもらし癖がつく
IF TARGET >= 0 && !TALENT:おもらし癖
	IF (TALENT:幼児／幼児退行 || TALENT:小人体型 || (TALENT:幼稚 && TALENT:小柄体型)) && EXP:絶頂放尿経験 >= 15
		TFLAG:13 = 65
		CALL KOJO_MESSAGE_EVENT
		PRINTFORMW %CALLNAME%は[おもらし癖]がついた
		TALENT:おもらし癖 = 1
	ELSEIF EXP:絶頂放尿経験 >= 30
		TFLAG:13 = 65
		CALL KOJO_MESSAGE_EVENT
		PRINTFORMW %CALLNAME%は[おもらし癖]がついた
		TALENT:おもらし癖 = 1
	ENDIF
ENDIF

;反発刻印３があり、かつ[幼稚]である時に
IF TARGET >= 0 
	IF TALENT:幼稚 && MARK:反発刻印 >= 3
	;欲望が5かつ従順が5かつマゾっ気が5かつ異常経験が５以上になる
		SIF ABL:欲望 >= 5 && ABL:従順 >= 5 && ABL:マゾっ気 >= 5 && EXP:異常経験 >= 5
			CALL EVENT_YOUJI
	;反発刻印３があり、かつ[幼稚]でなく、不死身がない時に
	ELSEIF !TALENT:不死身 && !TALENT:幼稚 && MARK:反発刻印 >= 3
	;欲望が5かつ従順が5かつマゾっ気が5かつ異常経験が７以上に加え露出５とおもらし癖がつく
		SIF ABL:欲望 >= 5 && ABL:従順 >= 5 && ABL:マゾっ気 >= 5 && ABL:露出癖 >= 5 && EXP:異常経験 >= 7 && TALENT:おもらし癖
			CALL EVENT_YOUJI
	ENDIF
ENDIF

;毛が生えてくる
REPEAT CHARANUM
	IF TALENT:COUNT:パイパン == 2
		BASE:COUNT:毛 += 10
		IF BASE:COUNT:毛 >= 300
			TALENT:COUNT:パイパン = 0
			PRINTFORML %CALLNAME:COUNT%の毛が生えてきた
		ENDIF
	ENDIF
REND

;発情期のカウント
CALL ESTRUS_PERIOD_COUNT

;季節イベントフラグの処理
REPEAT CHARANUM
	CFLAG:COUNT:612 = 0
	SIF FLAG:80 == 12 && FLAG:81 == 31
		CFLAG:COUNT:613 = 0
REND

;夜イベントキャンセルフラグが立ってる場合、ここでリセット
SIF FLAG:180 == 1
	FLAG:180 = 0

;奴隷と道具の維持費の処理
;STARTモード限定でEASYでは20日、NORMALでは15日、HARDでは10日免除
A = 300
B = 25-FLAG:4*5
REPEAT 25
	SIF ITEM:COUNT
		A += 50
REND
A += CHARANUM*200
A -= 100
;労役中の奴隷は除く
REPEAT CHARANUM
	SIF CFLAG:COUNT:12 > 0
		A -= 200
REND
IF FLAG:5 == 0 && A && DAY > B
	PRINTFORML 奴隷と道具の維持費、生活費に{A}朱かかった……
	MONEY -= A
ENDIF

@EVENT_YOUJI
;幼児退行
TFLAG:13 = 66
CALL KOJO_MESSAGE_EVENT
TALENT:幼稚 = 0
TALENT:一線越えない = 0
TALENT:貞操観念 = 0
TALENT:抑圧 = 0
TALENT:抵抗 = 0
TALENT:幼児／幼児退行 = 1
MARK:反発刻印 = 0


;-------------------------------------------------
;朝になった時のイベント
;-------------------------------------------------
@EVENT_NEWDAY
;奴隷レンタルの期日が来た場合の奴隷返却処理
REPEAT CHARANUM
	IF CFLAG:COUNT:12 == 1 && CFLAG:COUNT:13 == DAY
		A = COUNT
		CALL RETURN_SLAVE
	ENDIF
REND

;娼館バイトが終わった場合の終了処理
REPEAT CHARANUM
	IF CFLAG:COUNT:12 == 2
		A = COUNT
		CALL END_PROSTITUTION
	ENDIF
REND

;内番-手合わせが終わった場合の終了処理
IF FLAG:161 & 1
	CALL END_DUTY_PRACTICE
ENDIF

;内番-畑当番が終わった場合の終了処理
IF FLAG:161 & 2
	CALL END_DUTY_HATAKE
ENDIF

;内番-馬当番が終わった場合の終了処理
IF FLAG:161 & 4
	CALL END_DUTY_UMA
ENDIF

;極修行が終わった場合の終了処理
IF FLAG:161 & 8 
	REPEAT CHARANUM
		IF CFLAG:COUNT:13 == DAY
			CALL END_KIWAME
			BREAK
		ENDIF
	REND
	
ENDIF

;労役中は妊娠発覚しない為、妊娠関連処理を労役終了処理後に移動
;全体の妊娠判定の処理
CALL IN_VAGINA_ANAL_ALL

;全体の妊娠発覚時のイベント
CALL GET_CHILD_ALL

;排卵誘発剤と避妊結界の効果終了処理
REPEAT CHARANUM
	IF CFLAG:COUNT:108
		PRINTFORMW %CALLNAME:COUNT%の避妊結界の効果が切れたようだ
		CFLAG:COUNT:108 = 0
	ELSEIF CFLAG:COUNT:109
		PRINTFORMW %CALLNAME:COUNT%の排卵誘発剤の効果が切れたようだ
		CFLAG:COUNT:109 = 0
	ENDIF
REND

;出産･育児室関連
LOCAL = CHARANUM
$INPUT_LOOP
REPEAT LOCAL
	IF TALENT:COUNT:妊娠 || CFLAG:COUNT:26

		;出産3日前からは臨月突入で調教不可に
		IF (CFLAG:COUNT:110 - 3) == DAY
			DRAWLINE
			CALL REACH_FULL_TERM
		;出産前日には育児室への訪問を問うイベント発生
		ELSEIF (CFLAG:COUNT:110 - 1) == DAY && TFLAG:701 != DAY
			;父親をFATHERとする(いなければ-1)
			FATHER = GETCHARA(CFLAG:COUNT:111)
			
			DRAWLINE
			PRINTFORML %CALLNAME:COUNT%は出産が近づいているようだ……
			PRINTFORML %CALLNAME:COUNT%の様子を見に行きますか？
			PRINTL [0] - 育児室へ行く
			SIF FATHER >= 0 && FATHER != MASTER
				PRINTFORML [1] - 父親の%CALLNAME:(FATHER)%に行かせる
			PRINTL [2] - 育児室へ行かない
			INPUT
			IF RESULT == 0 || (RESULT == 1 && FATHER >= 0 && FATHER != MASTER)
				TFLAG:700 = 1
				TFLAG:701 = DAY
				TFLAG:702 = TIME
				CALL CHILD_CARE_ROOM(FATHER, RESULT)
			ELSEIF RESULT == 2
				DRAWLINE
			ELSE
				GOTO INPUT_LOOP
			ENDIF
		;出産予定日、または出産予定日を過ぎて出産していなければ出産
		ELSEIF CFLAG:COUNT:110 == DAY || (CFLAG:COUNT:110 < DAY && TALENT:COUNT:妊娠)
			DRAWLINE
			C = COUNT
			CALL CHILD_BIRTH
		ELSEIF CFLAG:COUNT:26
			;父親をFATHERとする
			FATHER = GETCHARA(CFLAG:COUNT:1000)
			
			LOCAL:1 = -1
			LOCAL:2 = 0
			;子育てしているのは誰か
			FOR LOCAL, 0, CHARANUM
				SIF CFLAG:COUNT:115 == NO:LOCAL
					LOCAL:1 = LOCAL
			NEXT
			;育てているのは実子か
			SIF CFLAG:(LOCAL:1):114 == NO:COUNT
				LOCAL:2 = 1
			;出産後3日には育児室への訪問を問うイベント発生
			IF (CFLAG:COUNT:116 + 3) == DAY && TFLAG:701 != DAY
				DRAWLINE
				PRINTFORML %CALLNAME:(LOCAL:1)%が%CALLNAME:COUNT%\@ LOCAL:2 ? を出産して # を育てはじめて \@から三日経ちました
				PRINTFORML %CALLNAME:(LOCAL:1)%の様子を見に行きますか？
				PRINTL [0] - 育児室へ行く
				SIF FATHER >= 0 && FATHER != MASTER
					PRINTFORML [1] - 父親の%CALLNAME:(FATHER)%に行かせる
				PRINTL [2] - 育児室へ行かない
				INPUT
				IF RESULT == 0 || (RESULT == 1 && FATHER >= 0 && FATHER != MASTER)
					TFLAG:700 = 1
					TFLAG:701 = DAY
					TFLAG:702 = TIME
					CALL CHILD_CARE_ROOM(FATHER, RESULT)
				ELSEIF RESULT == 2
					DRAWLINE
				ELSE
					GOTO INPUT_LOOP
				ENDIF
			;出産後5日には育児室への訪問を問うイベント発生
			ELSEIF (CFLAG:COUNT:116 + 5) == DAY && TFLAG:701 != DAY
				DRAWLINE
				PRINTFORML %CALLNAME:(LOCAL:1)%が%CALLNAME:COUNT%\@ LOCAL:2 ? を出産して # を育てはじめて \@から五日経ちました
				PRINTFORML %CALLNAME:(LOCAL:1)%の様子を見に行きますか？
				PRINTL [0] - 育児室へ行く
				SIF FATHER >= 0 && FATHER != MASTER
					PRINTFORML [1] - 父親の%CALLNAME:(FATHER)%に行かせる
				PRINTL [2] - 育児室へ行かない
				INPUT
				IF RESULT == 0 || (RESULT == 1 && FATHER >= 0 && FATHER != MASTER)
					TFLAG:700 = 1
					TFLAG:701 = DAY
					TFLAG:702 = TIME
					CALL CHILD_CARE_ROOM(FATHER, RESULT)
				ELSEIF RESULT == 2
					DRAWLINE
				ELSE
					GOTO INPUT_LOOP
				ENDIF
			;出産後10日には育児室への訪問を問うイベント発生
			ELSEIF (CFLAG:COUNT:116 + 10) == DAY && TFLAG:701 != DAY
				DRAWLINE
				PRINTFORML %CALLNAME:(LOCAL:1)%が%CALLNAME:COUNT%\@ LOCAL:2 ? を出産して # を育てはじめて \@から十日経ちました
				PRINTFORML %CALLNAME:(LOCAL:1)%の様子を見に行きますか？
				PRINTL [0] - 育児室へ行く
				SIF FATHER >= 0 && FATHER != MASTER
					PRINTFORML [1] - 父親の%CALLNAME:(FATHER)%に行かせる
				PRINTL [2] - 育児室へ行かない
				INPUT
				IF RESULT == 0 || (RESULT == 1 && FATHER >= 0 && FATHER != MASTER)
					TFLAG:700 = 1
					TFLAG:701 = DAY
					TFLAG:702 = TIME
					CALL CHILD_CARE_ROOM(FATHER, RESULT)
				ELSEIF RESULT == 2
					DRAWLINE
				ELSE
					GOTO INPUT_LOOP
				ENDIF
			;出産後15日には育児室への訪問を問うイベント発生
			ELSEIF (CFLAG:COUNT:116 + 15) == DAY && TFLAG:701 != DAY
				DRAWLINE
				PRINTFORML %CALLNAME:(LOCAL:1)%が%CALLNAME:COUNT%\@ LOCAL:2 ? を出産して # を育てはじめて \@から十五日経ちました
				PRINTFORML %CALLNAME:(LOCAL:1)%の様子を見に行きますか？
				PRINTL [0] - 育児室へ行く
				SIF FATHER >= 0 && FATHER != MASTER
					PRINTFORML [1] - 父親の%CALLNAME:(FATHER)%に行かせる
				PRINTL [2] - 育児室へ行かない
				INPUT
				IF RESULT == 0 || (RESULT == 1 && FATHER >= 0 && FATHER != MASTER)
					TFLAG:700 = 1
					TFLAG:701 = DAY
					TFLAG:702 = TIME
					CALL CHILD_CARE_ROOM(FATHER, RESULT)
				ELSEIF RESULT == 2
					DRAWLINE
				ELSE
					GOTO INPUT_LOOP
				ENDIF
			;出産20日で親離れで調教可能に
			ELSEIF (CFLAG:COUNT:116 + 20) == DAY || ((CFLAG:COUNT:116 + 20) < DAY && TALENT:(LOCAL:1):育児中)
				C = COUNT
				DRAWLINE
				CALL DEPEARENT
				LOCAL = CHARANUM
				GOTO INPUT_LOOP
			ENDIF
		ENDIF
	ENDIF
REND

;Ｃ感覚５以上、精液経験100以上
IF TARGET >= 0
	IF TALENT:子供サイズ
		IF ABL:Ｃ感覚 >= 5 && EXP:精液経験 >= 100
			TFLAG:13 = 70
			CALL KOJO_MESSAGE_EVENT
			TALENT:子供サイズ = 0
			TALENT:短小 = 1
		ENDIF
	ENDIF
ENDIF

